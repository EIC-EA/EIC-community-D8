<?php

/**
 * @file
 * Primary module hooks for EIC Administration module.
 */

use Drupal\Core\Datetime\Entity\DateFormat;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Entity\EntityFormInterface;

/**
 * Implements template_preprocess_views_view_field().
 */
function eic_admin_preprocess_views_view_field(&$vars) {
  if ($vars['view']->id() == 'closed_requests' && $vars['field']->options['id'] == 'flag_id') {
    // Users without the 'administer flags' permissions cannot see the flag
    // label, so we add it manually here.
    /** @var \Drupal\flag\FlaggingInterface $flagging */
    $flagging = $vars['row']->_entity;
    $flag_label = $flagging->getFlag()->label();
    $vars['output'] = $flag_label;
    $vars['field']->last_render = $flag_label;
  }

  if ($vars['view']->current_display === 'page_admin_groups') {
    $group = $vars['row']->_entity;

    if (!$group instanceof \Drupal\group\Entity\GroupInterface) {
      return;
    }

    $is_group_sensitive = \Drupal::service('eic_groups.helper')->isGroupSensitive($group);
    //We only alter on sensitive group which user has no permissions.
    if ($group->access('view') || !$is_group_sensitive) {
      return;
    }

    if ($vars['field']->field === 'label') {
      $vars['output'] = t('Access denied: sensitive group with no access.');
      $vars['field']->last_render = t('Access denied: sensitive group with no access.');
    } else {
      $vars['output'] = '';
      $vars['field']->last_render = '';
    }
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function eic_admin_module_implements_alter(&$implementations, $hook) {
  if (\Drupal::service('module_handler')->moduleExists('oe_authentication')) {
    switch ($hook) {
      // OE Authentication module is removing some cancel methods.
      // Prevent this by removing this implementation.
      case 'user_cancel_methods_alter':
        unset($implementations['oe_authentication']);
        break;
    }
  }
}

/**
 * Implements hook_module_form_alter().
 */
function eic_admin_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  $currentTheme = \Drupal::service('theme.manager')->getActiveTheme();
  $adminThemeName = \Drupal::config('system.theme')->get('admin');
  $form_object = $form_state->getFormObject();
  if (!$form_object instanceof EntityFormInterface) {
    return;
  }
  $entity = $form_object->getEntity();
  if ($entity->getEntityTypeId() == 'node' && $currentTheme->getName() == $adminThemeName) {
    $form['#attached']['library'][] = 'eic_admin/admin_ux';
  }
}

/**
 * Implements hook_theme_suggestions_HOOK_alter().
 */
function eic_admin_theme_suggestions_input_alter(array &$suggestions, array $variables) {
  $currentTheme = \Drupal::service('theme.manager')->getActiveTheme()->getName();
  $adminThemeName = \Drupal::config('system.theme')->get('admin');
  if ($currentTheme == $adminThemeName) {
    // Check if in node-edit form and element is date and not in custom fields.
    if ($variables['theme_hook_original'] === 'input__date' && $variables['element']['#attributes']['type'] === 'date' && substr($variables['element']['#name'], 0, 5) !== "field") {
      $suggestions[] = 'input__date__calendar';
    }
  }
  return $suggestions;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function eic_admin_preprocess_input__date__calendar(&$variables) {
  $eu_short_date_pattern = DateFormat::load('eu_short_date')->getPattern();
  $variables['element']['#attached']['library'][] = 'eic_community/pikaday';
  $variables['element']['#date_date_format']= $eu_short_date_pattern;
  $variables['attributes']['type'] = 'text';
  $variables['eu_short_date'] = $eu_short_date_pattern;
}

/**
 * Implements hook_theme().
 */
function eic_admin_theme($existing, $type, $theme, $path) {
  return [
    'input__date__calendar' => [
      'template' => 'input--date--calendar',
      'base hook' => 'input__date'
    ],
  ];
}
